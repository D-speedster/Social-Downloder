# 🔍 راهنمای دیباگ سیستم بازیابی دستی

## مشکل گزارش شده
سیستم بازیابی دستی فقط پیام‌های ادمین را پردازش می‌کند، نه همه کاربران.

## تغییرات اعمال شده

### 1. اضافه کردن لاگ‌های دیباگ
- لاگ کردن هر update با user_id و زمان
- نمایش اینکه آیا update در بازه زمانی قرار دارد یا نه

### 2. بررسی کد
کد فعلی درست است و باید به همه کاربران پیام بدهد:
- `_fetch_all_updates`: همه updates را از Telegram می‌گیرد
- `_filter_by_time`: فقط بر اساس زمان فیلتر می‌کند (نه user_id)
- `_process_message`: به هر کاربری که پیام داده پاسخ می‌دهد

## چطور تست کنیم؟

### مرحله 1: آماده‌سازی
1. ربات را خاموش کنید
2. از 2-3 اکانت مختلف (غیر از ادمین) به ربات پیام بدهید
3. ربات را روشن کنید

### مرحله 2: اجرای بازیابی
1. به پنل ادمین بروید
2. روی "📨 پیام‌های آفلاین" کلیک کنید
3. عدد 30 را وارد کنید (برای 30 دقیقه اخیر)

### مرحله 3: بررسی لاگ‌ها
فایل `logs/manual_recovery.log` را باز کنید و به دنبال این موارد بگردید:

```
Total updates: X
Filtered updates: Y
Update from user XXXXX: time=HH:MM:SS, cutoff=HH:MM:SS, included=True/False
Processing message from user XXXXX: ...
Notified user XXXXX about missed message
```

## احتمالات مشکل

### احتمال 1: Telegram API محدودیت دارد
Telegram فقط 100 update آخر را نگه می‌دارد. اگر پیام‌های کاربران قدیمی‌تر باشند، دریافت نمی‌شوند.

**راه حل**: بازه زمانی کوچک‌تری امتحان کنید (مثلاً 5 دقیقه)

### احتمال 2: پیام‌ها خارج از بازه زمانی هستند
اگر پیام‌ها بیش از 30 دقیقه قبل ارسال شده باشند، فیلتر می‌شوند.

**راه حل**: بازه زمانی بزرگ‌تری امتحان کنید (مثلاً 120 دقیقه)

### احتمال 3: پیام‌ها قبلاً پردازش شده‌اند
اگر `last_update_id` در دیتابیس ذخیره شده باشد، پیام‌های قدیمی‌تر نادیده گرفته می‌شوند.

**راه حل**: در کد فعلی، ما از `offset=0` استفاده می‌کنیم که این مشکل را حل می‌کند.

## نتیجه‌گیری

کد فعلی **صحیح** است و باید به همه کاربران پیام بدهد. اگر هنوز مشکل دارید:

1. لاگ‌ها را بررسی کنید
2. مطمئن شوید پیام‌های تست در بازه زمانی صحیح هستند
3. تعداد updates دریافت شده را چک کنید

## دستورات مفید برای دیباگ

```bash
# مشاهده لاگ‌های بازیابی
tail -f logs/manual_recovery.log

# جستجوی پیام‌های خاص
grep "Processing message" logs/manual_recovery.log

# شمارش تعداد کاربران اطلاع‌رسانی شده
grep "Notified user" logs/manual_recovery.log | wc -l
```

## تماس با پشتیبانی

اگر مشکل همچنان ادامه دارد، لطفاً موارد زیر را ارسال کنید:
- محتوای فایل `logs/manual_recovery.log`
- تعداد updates دریافت شده
- تعداد updates فیلتر شده
- user_id های مختلف که پیام داده‌اند
