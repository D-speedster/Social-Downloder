#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Setup Wizard for YouTube Downloader Bot
This script helps users configure the bot for the first time by creating .env file
"""

import os
import sys
from pathlib import Path
from typing import Optional


class SetupWizard:
    def __init__(self):
        self.env_path = Path('.env')
        self.required_vars = ['API_ID', 'API_HASH', 'BOT_TOKEN']
        
    def check_env_exists(self) -> bool:
        """Check if .env file exists and contains required variables"""
        if not self.env_path.exists():
            return False
            
        try:
            with open(self.env_path, 'r', encoding='utf-8') as f:
                content = f.read()
                
            # Check if all required variables exist
            for var in self.required_vars:
                if f'{var}=' not in content:
                    return False
                    
            return True
        except Exception as e:
            print(f"Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„ .env: {e}")
            return False
    
    def get_user_input(self, prompt: str, required: bool = True, hide_input: bool = False) -> Optional[str]:
        """Get input from user with validation"""
        import getpass
        
        while True:
            if hide_input:
                value = getpass.getpass(prompt)
            else:
                value = input(prompt).strip()
                
            if not value and required:
                print("âŒ Ø§ÛŒÙ† ÙÛŒÙ„Ø¯ Ø§Ø¬Ø¨Ø§Ø±ÛŒ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ù…Ù‚Ø¯Ø§Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.")
                continue
                
            return value if value else None
    
    def validate_api_id(self, api_id: str) -> bool:
        """Validate API_ID format"""
        try:
            int(api_id)
            return len(api_id) >= 6
        except ValueError:
            return False
    
    def validate_bot_token(self, token: str) -> bool:
        """Validate BOT_TOKEN format"""
        # Basic validation: should contain ':' and be long enough
        return ':' in token and len(token) > 20
    
    def create_env_file(self, config: dict) -> bool:
        """Create .env file with provided configuration"""
        try:
            env_content = f"""# YouTube Downloader Bot Configuration
# Generated by Setup Wizard

# Telegram API Configuration
API_ID={config['API_ID']}
API_HASH={config['API_HASH']}
BOT_TOKEN={config['BOT_TOKEN']}

# Optional: Session file path (default: current directory)
SESSION_PATH={config.get('SESSION_PATH', '.')}

# Bot Configuration
DOWNLOAD_LOCATION=./downloads
MAX_WORKERS=8

# Database Configuration
DB_PATH=./plugins/bot_database.db
"""
            
            with open(self.env_path, 'w', encoding='utf-8') as f:
                f.write(env_content)
                
            # Set appropriate permissions (readable only by owner)
            os.chmod(self.env_path, 0o600)
            
            return True
            
        except Exception as e:
            print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ .env: {e}")
            return False
    
    def run_wizard(self) -> bool:
        """Run the setup wizard"""
        print("\n" + "="*60)
        print("ğŸš€ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ Ø¨Ù‡ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø² Ø±Ø¨Ø§Øª Ø¯Ø§Ù†Ù„ÙˆØ¯Ø± ÛŒÙˆØªÛŒÙˆØ¨")
        print("="*60)
        print("\nØ¨Ø±Ø§ÛŒ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø±Ø¨Ø§ØªØŒ Ù„Ø·ÙØ§Ù‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø²ÛŒØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
        print("\nğŸ“‹ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª:")
        print("â€¢ API_ID Ùˆ API_HASH: Ø§Ø² https://my.telegram.org Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†ÛŒØ¯")
        print("â€¢ BOT_TOKEN: Ø§Ø² @BotFather Ø¯Ø± ØªÙ„Ú¯Ø±Ø§Ù… Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†ÛŒØ¯")
        print("\n" + "-"*60 + "\n")
        
        config = {}
        
        # Get API_ID
        while True:
            api_id = self.get_user_input("ğŸ”‘ API_ID Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯: ")
            if self.validate_api_id(api_id):
                config['API_ID'] = api_id
                break
            else:
                print("âŒ API_ID Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. Ø¨Ø§ÛŒØ¯ ÛŒÚ© Ø¹Ø¯Ø¯ Ø­Ø¯Ø§Ù‚Ù„ 6 Ø±Ù‚Ù…ÛŒ Ø¨Ø§Ø´Ø¯.")
        
        # Get API_HASH
        while True:
            api_hash = self.get_user_input("ğŸ” API_HASH Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯: ")
            if len(api_hash) >= 32:
                config['API_HASH'] = api_hash
                break
            else:
                print("âŒ API_HASH Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ 32 Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯.")
        
        # Get BOT_TOKEN
        while True:
            bot_token = self.get_user_input("ğŸ¤– BOT_TOKEN Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯: ", hide_input=True)
            if self.validate_bot_token(bot_token):
                config['BOT_TOKEN'] = bot_token
                break
            else:
                print("âŒ BOT_TOKEN Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. ÙØ±Ù…Øª ØµØ­ÛŒØ­: 123456789:ABCdefGHIjklMNOpqrSTUvwxyz")
        
        # Get optional session path
        session_path = self.get_user_input(
            "ğŸ“ Ù…Ø³ÛŒØ± Ø°Ø®ÛŒØ±Ù‡ session (Ø§Ø®ØªÛŒØ§Ø±ÛŒØŒ Enter Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶): ", 
            required=False
        )
        if session_path:
            config['SESSION_PATH'] = session_path
        
        print("\n" + "-"*60)
        print("ğŸ“ Ø¯Ø± Ø­Ø§Ù„ Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ .env...")
        
        if self.create_env_file(config):
            print("âœ… ÙØ§ÛŒÙ„ .env Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯!")
            print("\nğŸ‰ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ Ø´Ø¯! Ø­Ø§Ù„Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø±Ø¨Ø§Øª Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯:")
            print("   python bot.py")
            print("\nâš ï¸  Ù†Ú©ØªÙ‡ Ø§Ù…Ù†ÛŒØªÛŒ: ÙØ§ÛŒÙ„ .env Ø­Ø§ÙˆÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø­Ø³Ø§Ø³ Ø§Ø³Øª.")
            print("   Ø¢Ù† Ø±Ø§ Ø¯Ø± GitHub ÛŒØ§ Ø³Ø§ÛŒØ± Ù…Ø®Ø§Ø²Ù† Ø¹Ù…ÙˆÙ…ÛŒ Ù‚Ø±Ø§Ø± Ù†Ø¯Ù‡ÛŒØ¯.")
            return True
        else:
            print("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ .env")
            return False
    
    def check_and_run(self) -> bool:
        """Check if setup is needed and run wizard if necessary"""
        if self.check_env_exists():
            print("âœ… ÙØ§ÛŒÙ„ .env Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú©Ø§Ù…Ù„ Ø§Ø³Øª.")
            return True
        else:
            print("âš ï¸  ÙØ§ÛŒÙ„ .env Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª ÛŒØ§ Ù†Ø§Ù‚Øµ Ø§Ø³Øª.")
            response = input("Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø² Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯ØŸ (y/n): ").lower()
            if response in ['y', 'yes', 'Ø¨Ù„Ù‡', 'Ø¢Ø±Ù‡']:
                return self.run_wizard()
            else:
                print("âŒ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù„ØºÙˆ Ø´Ø¯.")
                return False


def run_setup_wizard():
    """ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ wizard ØªÙ†Ø¸ÛŒÙ…Ø§Øª"""
    wizard = SetupWizard()
    
    if wizard.check_env_exists():
        print("âœ… ÙØ§ÛŒÙ„ .env Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª Ùˆ ØªÙ…Ø§Ù… Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯.")
        return True
    
    print("ğŸš€ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ wizard ØªÙ†Ø¸ÛŒÙ…Ø§Øª...")
    success = wizard.run_wizard()
    
    if success:
        print("\nâœ… ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ú©Ø§Ù…Ù„ Ø´Ø¯!")
        print("Ø§Ú©Ù†ÙˆÙ† Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø±Ø¨Ø§Øª Ø±Ø§ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ú©Ù†ÛŒØ¯.")
    else:
        print("\nâŒ Ø®Ø·Ø§ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.")
        sys.exit(1)
    
    return success

def main():
    """Main function to run setup wizard"""
    wizard = SetupWizard()
    
    try:
        success = wizard.check_and_run()
        sys.exit(0 if success else 1)
    except KeyboardInterrupt:
        print("\n\nâŒ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ØªÙˆØ³Ø· Ú©Ø§Ø±Ø¨Ø± Ù„ØºÙˆ Ø´Ø¯.")
        sys.exit(1)
    except Exception as e:
        print(f"\nâŒ Ø®Ø·Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡: {e}")
        sys.exit(1)


if __name__ == "__main__":
    main()