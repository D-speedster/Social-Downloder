#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø­ÛŒØ· Ø³Ø±ÙˆØ± Ù„ÛŒÙ†ÙˆÚ©Ø³
ØªÙ†Ø¸ÛŒÙ… DNS Ùˆ Ø´Ø¨Ú©Ù‡ Ø¨Ø±Ø§ÛŒ Ø­Ù„ Ù…Ø´Ú©Ù„Ø§Øª Ø¯Ø§Ù†Ù„ÙˆØ¯ ÛŒÙˆØªÛŒÙˆØ¨
"""

import os
import sys
import socket
import subprocess
import platform
from pathlib import Path

class LinuxServerSetup:
    def __init__(self):
        self.is_linux = platform.system().lower() == 'linux'
        self.dns_servers = [
            '8.8.8.8',      # Google DNS
            '8.8.4.4',      # Google DNS Secondary
            '1.1.1.1',      # Cloudflare DNS
            '1.0.0.1',      # Cloudflare DNS Secondary
            '208.67.222.222', # OpenDNS
            '208.67.220.220'  # OpenDNS Secondary
        ]
    
    def check_system(self):
        """Ø¨Ø±Ø±Ø³ÛŒ Ø³ÛŒØ³ØªÙ… Ø¹Ø§Ù…Ù„"""
        print(f"Ø³ÛŒØ³ØªÙ… Ø¹Ø§Ù…Ù„: {platform.system()}")
        print(f"Ù†Ø³Ø®Ù‡: {platform.release()}")
        print(f"Ù…Ø¹Ù…Ø§Ø±ÛŒ: {platform.machine()}")
        
        if not self.is_linux:
            print("âš ï¸ Ø§ÛŒÙ† Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¨Ø±Ø§ÛŒ Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§ÛŒ Ù„ÛŒÙ†ÙˆÚ©Ø³ Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª")
            return False
        
        return True
    
    def test_dns_servers(self):
        """ØªØ³Øª DNS serverÙ‡Ø§"""
        print("\n--- ØªØ³Øª DNS Servers ---")
        working_dns = []
        
        for dns in self.dns_servers:
            try:
                # ØªØ³Øª DNS Ø¨Ø§ nslookup
                result = subprocess.run(
                    ['nslookup', 'youtube.com', dns],
                    capture_output=True,
                    text=True,
                    timeout=10
                )
                
                if result.returncode == 0:
                    print(f"âœ… DNS {dns}: Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯")
                    working_dns.append(dns)
                else:
                    print(f"âŒ DNS {dns}: Ú©Ø§Ø± Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯")
                    
            except Exception as e:
                print(f"âŒ DNS {dns}: Ø®Ø·Ø§ - {e}")
        
        return working_dns
    
    def configure_dns(self, working_dns):
        """ØªÙ†Ø¸ÛŒÙ… DNS Ø¯Ø± Ø³ÛŒØ³ØªÙ…"""
        if not working_dns:
            print("âŒ Ù‡ÛŒÚ† DNS Ø³Ø±ÙˆØ± Ú©Ø§Ø±ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯!")
            return False
        
        print(f"\n--- ØªÙ†Ø¸ÛŒÙ… DNS Ø¨Ø§ {len(working_dns)} Ø³Ø±ÙˆØ± ---")
        
        try:
            # Ø¨Ú©â€ŒØ¢Ù¾ ÙØ§ÛŒÙ„ resolv.conf
            subprocess.run(['sudo', 'cp', '/etc/resolv.conf', '/etc/resolv.conf.backup'])
            print("âœ… Ø¨Ú©â€ŒØ¢Ù¾ /etc/resolv.conf Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯")
            
            # Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯ resolv.conf
            resolv_content = "# Generated by YouTube Downloader Setup\n"
            for dns in working_dns[:4]:  # Ø­Ø¯Ø§Ú©Ø«Ø± 4 DNS
                resolv_content += f"nameserver {dns}\n"
            
            resolv_content += """
# Options for better DNS resolution
options timeout:5
options attempts:3
options rotate
options single-request-reopen
"""
            
            # Ù†ÙˆØ´ØªÙ† ÙØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯
            with open('/tmp/resolv.conf.new', 'w') as f:
                f.write(resolv_content)
            
            subprocess.run(['sudo', 'mv', '/tmp/resolv.conf.new', '/etc/resolv.conf'])
            print("âœ… ÙØ§ÛŒÙ„ /etc/resolv.conf Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯")
            
            return True
            
        except Exception as e:
            print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ… DNS: {e}")
            return False
    
    def configure_network_settings(self):
        """ØªÙ†Ø¸ÛŒÙ… Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ø´Ø¨Ú©Ù‡"""
        print("\n--- ØªÙ†Ø¸ÛŒÙ… Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ø´Ø¨Ú©Ù‡ ---")
        
        network_settings = {
            'net.ipv4.tcp_keepalive_time': '600',
            'net.ipv4.tcp_keepalive_intvl': '60',
            'net.ipv4.tcp_keepalive_probes': '3',
            'net.core.rmem_default': '262144',
            'net.core.rmem_max': '16777216',
            'net.core.wmem_default': '262144',
            'net.core.wmem_max': '16777216',
            'net.ipv4.tcp_rmem': '4096 65536 16777216',
            'net.ipv4.tcp_wmem': '4096 65536 16777216',
        }
        
        try:
            for setting, value in network_settings.items():
                subprocess.run(['sudo', 'sysctl', '-w', f'{setting}={value}'])
                print(f"âœ… {setting} = {value}")
            
            print("âœ… Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ø´Ø¨Ú©Ù‡ ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù†Ø¯")
            return True
            
        except Exception as e:
            print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ… Ø´Ø¨Ú©Ù‡: {e}")
            return False
    
    def install_dependencies(self):
        """Ù†ØµØ¨ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²"""
        print("\n--- Ù†ØµØ¨ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ ---")
        
        packages = [
            'python3-pip',
            'python3-dev',
            'build-essential',
            'libssl-dev',
            'libffi-dev',
            'curl',
            'wget',
            'dnsutils'
        ]
        
        try:
            # Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„ÛŒØ³Øª Ù¾Ú©ÛŒØ¬â€ŒÙ‡Ø§
            subprocess.run(['sudo', 'apt', 'update'], check=True)
            print("âœ… Ù„ÛŒØ³Øª Ù¾Ú©ÛŒØ¬â€ŒÙ‡Ø§ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯")
            
            # Ù†ØµØ¨ Ù¾Ú©ÛŒØ¬â€ŒÙ‡Ø§
            for package in packages:
                result = subprocess.run(['sudo', 'apt', 'install', '-y', package])
                if result.returncode == 0:
                    print(f"âœ… {package} Ù†ØµØ¨ Ø´Ø¯")
                else:
                    print(f"âš ï¸ {package} Ù†ØµØ¨ Ù†Ø´Ø¯")
            
            return True
            
        except Exception as e:
            print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†ØµØ¨ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§: {e}")
            return False
    
    def configure_python_environment(self):
        """ØªÙ†Ø¸ÛŒÙ… Ù…Ø­ÛŒØ· Ù¾Ø§ÛŒØªÙˆÙ†"""
        print("\n--- ØªÙ†Ø¸ÛŒÙ… Ù…Ø­ÛŒØ· Ù¾Ø§ÛŒØªÙˆÙ† ---")
        
        try:
            # Ù†ØµØ¨/Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ pip
            subprocess.run([sys.executable, '-m', 'pip', 'install', '--upgrade', 'pip'])
            print("âœ… pip Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯")
            
            # Ù†ØµØ¨ Ù¾Ú©ÛŒØ¬â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒØªÙˆÙ† Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²
            python_packages = [
                'yt-dlp>=2023.12.30',
                'aiohttp>=3.9.0',
                'aiofiles>=23.0.0',
                'urllib3>=2.0.0',
                'certifi>=2023.0.0',
                'requests>=2.31.0'
            ]
            
            for package in python_packages:
                result = subprocess.run([sys.executable, '-m', 'pip', 'install', package])
                if result.returncode == 0:
                    print(f"âœ… {package} Ù†ØµØ¨ Ø´Ø¯")
                else:
                    print(f"âš ï¸ {package} Ù†ØµØ¨ Ù†Ø´Ø¯")
            
            return True
            
        except Exception as e:
            print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ… Ù…Ø­ÛŒØ· Ù¾Ø§ÛŒØªÙˆÙ†: {e}")
            return False
    
    def create_environment_script(self):
        """Ø§ÛŒØ¬Ø§Ø¯ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª ØªÙ†Ø¸ÛŒÙ… Ù…Ø­ÛŒØ·"""
        print("\n--- Ø§ÛŒØ¬Ø§Ø¯ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ù…Ø­ÛŒØ· ---")
        
        env_script = """#!/bin/bash
# YouTube Downloader Environment Setup

# Set DNS timeout
export PYTHONHTTPSVERIFY=0
export CURL_CA_BUNDLE=""
export REQUESTS_CA_BUNDLE=""

# Network timeouts
export SOCKET_TIMEOUT=60
export CONNECT_TIMEOUT=45
export READ_TIMEOUT=120

# Python optimizations
export PYTHONUNBUFFERED=1
export PYTHONDONTWRITEBYTECODE=1

# DNS settings
export RES_OPTIONS="timeout:5 attempts:3 rotate single-request-reopen"

echo "YouTube Downloader environment configured!"
"""
        
        try:
            with open('youtube_env.sh', 'w') as f:
                f.write(env_script)
            
            os.chmod('youtube_env.sh', 0o755)
            print("âœ… Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ù…Ø­ÛŒØ· Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯: youtube_env.sh")
            print("Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡: source youtube_env.sh")
            
            return True
            
        except Exception as e:
            print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ù…Ø­ÛŒØ·: {e}")
            return False
    
    def run_setup(self):
        """Ø§Ø¬Ø±Ø§ÛŒ Ú©Ø§Ù…Ù„ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ"""
        print("=" * 60)
        print("Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø­ÛŒØ· Ø³Ø±ÙˆØ± Ù„ÛŒÙ†ÙˆÚ©Ø³ Ø¨Ø±Ø§ÛŒ YouTube Downloader")
        print("=" * 60)
        
        if not self.check_system():
            return False
        
        steps = [
            ("ØªØ³Øª DNS Servers", self.test_dns_servers),
            ("Ù†ØµØ¨ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§", self.install_dependencies),
            ("ØªÙ†Ø¸ÛŒÙ… Ù…Ø­ÛŒØ· Ù¾Ø§ÛŒØªÙˆÙ†", self.configure_python_environment),
            ("ØªÙ†Ø¸ÛŒÙ… Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ø´Ø¨Ú©Ù‡", self.configure_network_settings),
            ("Ø§ÛŒØ¬Ø§Ø¯ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ù…Ø­ÛŒØ·", self.create_environment_script),
        ]
        
        working_dns = None
        
        for step_name, step_func in steps:
            print(f"\nğŸ”„ {step_name}...")
            try:
                if step_name == "ØªØ³Øª DNS Servers":
                    working_dns = step_func()
                    if working_dns:
                        self.configure_dns(working_dns)
                else:
                    result = step_func()
                    if not result:
                        print(f"âŒ {step_name} Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯")
                        
            except Exception as e:
                print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± {step_name}: {e}")
        
        print("\n" + "=" * 60)
        print("Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ Ø´Ø¯!")
        print("=" * 60)
        print("Ù…Ø±Ø§Ø­Ù„ Ø¨Ø¹Ø¯ÛŒ:")
        print("1. source youtube_env.sh")
        print("2. python test_linux_server.py")
        print("3. python main.py")
        
        return True

def main():
    """ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ"""
    setup = LinuxServerSetup()
    
    try:
        success = setup.run_setup()
        return 0 if success else 1
        
    except KeyboardInterrupt:
        print("\nâŒ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù„ØºÙˆ Ø´Ø¯")
        return 2
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡: {e}")
        return 3

if __name__ == "__main__":
    exit_code = main()
    sys.exit(exit_code)