#!/bin/bash
# Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø­Ù„ Ø³Ø±ÛŒØ¹ Ù…Ø´Ú©Ù„ DNS Ø¨Ø±Ø§ÛŒ YouTube Downloader
# Quick DNS Fix Script for YouTube Downloader

echo "ðŸ”§ Ø´Ø±ÙˆØ¹ Ø­Ù„ Ø³Ø±ÛŒØ¹ Ù…Ø´Ú©Ù„ DNS..."
echo "ðŸ”§ Starting quick DNS fix..."

# Ø±Ù†Ú¯â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# ØªØ§Ø¨Ø¹ Ú†Ø§Ù¾ Ø±Ù†Ú¯ÛŒ
print_status() {
    case $2 in
        "success") echo -e "${GREEN}âœ… $1${NC}" ;;
        "warning") echo -e "${YELLOW}âš ï¸ $1${NC}" ;;
        "error") echo -e "${RED}âŒ $1${NC}" ;;
        *) echo "â„¹ï¸ $1" ;;
    esac
}

# Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ root
if [[ $EUID -ne 0 ]]; then
    print_status "Ø§ÛŒÙ† Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ sudo Ø¯Ø§Ø±Ø¯" "warning"
    echo "Ù„Ø·ÙØ§ Ø¨Ø§ sudo Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯: sudo $0"
    exit 1
fi

# Ø¨Ú©â€ŒØ¢Ù¾ ÙØ§ÛŒÙ„ resolv.conf
print_status "Ø§ÛŒØ¬Ø§Ø¯ Ø¨Ú©â€ŒØ¢Ù¾ Ø§Ø² /etc/resolv.conf..." "info"
if cp /etc/resolv.conf /etc/resolv.conf.backup.$(date +%Y%m%d_%H%M%S); then
    print_status "Ø¨Ú©â€ŒØ¢Ù¾ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯" "success"
else
    print_status "Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø¨Ú©â€ŒØ¢Ù¾" "error"
fi

# ØªÙ†Ø¸ÛŒÙ… DNS Ø¬Ø¯ÛŒØ¯
print_status "ØªÙ†Ø¸ÛŒÙ… DNS servers..." "info"
cat > /etc/resolv.conf << 'EOF'
# YouTube Downloader DNS Configuration
# Generated by quick_dns_fix.sh

# Google Public DNS (Primary)
nameserver 8.8.8.8
nameserver 8.8.4.4

# Cloudflare DNS (Secondary)
nameserver 1.1.1.1
nameserver 1.0.0.1

# DNS Options for better resolution
options timeout:5
options attempts:3
options rotate
options single-request-reopen
options inet6
EOF

if [[ $? -eq 0 ]]; then
    print_status "DNS servers ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù†Ø¯" "success"
else
    print_status "Ø®Ø·Ø§ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ… DNS" "error"
    exit 1
fi

# Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯ Ø³Ø±ÙˆÛŒØ³ DNS
print_status "Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ DNS..." "info"

# systemd-resolved
if systemctl is-active --quiet systemd-resolved; then
    systemctl restart systemd-resolved
    print_status "systemd-resolved Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯" "success"
fi

# networking service
if systemctl is-active --quiet networking; then
    systemctl restart networking
    print_status "networking service Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯" "success"
fi

# Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©Ø´ DNS
print_status "Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©Ø´ DNS..." "info"
if command -v systemd-resolve &> /dev/null; then
    systemd-resolve --flush-caches
    print_status "Ú©Ø´ DNS Ù¾Ø§Ú© Ø´Ø¯" "success"
fi

# ØªÙ†Ø¸ÛŒÙ… Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ø´Ø¨Ú©Ù‡
print_status "ØªÙ†Ø¸ÛŒÙ… Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ø´Ø¨Ú©Ù‡..." "info"

# TCP keepalive settings
sysctl -w net.ipv4.tcp_keepalive_time=600 > /dev/null 2>&1
sysctl -w net.ipv4.tcp_keepalive_intvl=60 > /dev/null 2>&1
sysctl -w net.ipv4.tcp_keepalive_probes=3 > /dev/null 2>&1

# Buffer sizes
sysctl -w net.core.rmem_default=262144 > /dev/null 2>&1
sysctl -w net.core.rmem_max=16777216 > /dev/null 2>&1
sysctl -w net.core.wmem_default=262144 > /dev/null 2>&1
sysctl -w net.core.wmem_max=16777216 > /dev/null 2>&1

print_status "Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ø´Ø¨Ú©Ù‡ ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù†Ø¯" "success"

# ØªØ³Øª DNS
print_status "ØªØ³Øª DNS..." "info"
sleep 2

# ØªØ³Øª Ø¨Ø§ nslookup
if command -v nslookup &> /dev/null; then
    if nslookup youtube.com 8.8.8.8 > /dev/null 2>&1; then
        print_status "ØªØ³Øª DNS Ø¨Ø§ Google Ù…ÙˆÙÙ‚" "success"
    else
        print_status "ØªØ³Øª DNS Ø¨Ø§ Google Ù†Ø§Ù…ÙˆÙÙ‚" "warning"
    fi
fi

# ØªØ³Øª Ø¨Ø§ dig
if command -v dig &> /dev/null; then
    if dig @1.1.1.1 youtube.com > /dev/null 2>&1; then
        print_status "ØªØ³Øª DNS Ø¨Ø§ Cloudflare Ù…ÙˆÙÙ‚" "success"
    else
        print_status "ØªØ³Øª DNS Ø¨Ø§ Cloudflare Ù†Ø§Ù…ÙˆÙÙ‚" "warning"
    fi
fi

# ØªØ³Øª ping
print_status "ØªØ³Øª Ø§ØªØµØ§Ù„..." "info"
if ping -c 2 youtube.com > /dev/null 2>&1; then
    print_status "Ø§ØªØµØ§Ù„ Ø¨Ù‡ YouTube Ù…ÙˆÙÙ‚" "success"
else
    print_status "Ø§ØªØµØ§Ù„ Ø¨Ù‡ YouTube Ù†Ø§Ù…ÙˆÙÙ‚" "warning"
fi

# Ø§ÛŒØ¬Ø§Ø¯ Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ø­ÛŒØ·
print_status "ØªÙ†Ø¸ÛŒÙ… Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ø­ÛŒØ·..." "info"
cat > /tmp/youtube_env_fix.sh << 'EOF'
#!/bin/bash
# YouTube Downloader Environment Variables

# DNS and Network Settings
export RES_OPTIONS="timeout:5 attempts:3 rotate single-request-reopen"
export SOCKET_TIMEOUT=60
export CONNECT_TIMEOUT=45
export READ_TIMEOUT=120

# Python Settings
export PYTHONUNBUFFERED=1
export PYTHONDONTWRITEBYTECODE=1
export PYTHONHTTPSVERIFY=0

# SSL Settings (if needed)
export CURL_CA_BUNDLE=""
export REQUESTS_CA_BUNDLE=""

echo "ðŸŒ YouTube Downloader environment configured!"
EOF

chmod +x /tmp/youtube_env_fix.sh
print_status "Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ø­ÛŒØ· Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯Ù†Ø¯" "success"

# Ø®Ù„Ø§ØµÙ‡ Ù†ØªØ§ÛŒØ¬
echo ""
echo "ðŸŽ‰ Ø­Ù„ Ø³Ø±ÛŒØ¹ Ù…Ø´Ú©Ù„ DNS Ú©Ø§Ù…Ù„ Ø´Ø¯!"
echo "ðŸ“‹ Ø®Ù„Ø§ØµÙ‡ ØªØºÛŒÛŒØ±Ø§Øª:"
echo "   â€¢ DNS servers: Google (8.8.8.8, 8.8.4.4) + Cloudflare (1.1.1.1, 1.0.0.1)"
echo "   â€¢ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ø´Ø¨Ú©Ù‡ Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù†Ø¯"
echo "   â€¢ Ú©Ø´ DNS Ù¾Ø§Ú© Ø´Ø¯"
echo "   â€¢ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ø´Ø¨Ú©Ù‡ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯Ù†Ø¯"
echo ""
echo "ðŸ“ Ù…Ø±Ø§Ø­Ù„ Ø¨Ø¹Ø¯ÛŒ:"
echo "   1. source /tmp/youtube_env_fix.sh"
echo "   2. python3 test_linux_server.py"
echo "   3. python3 main.py"
echo ""
echo "ðŸ”„ Ø¯Ø± ØµÙˆØ±Øª Ù…Ø´Ú©Ù„ØŒ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ:"
echo "   sudo cp /etc/resolv.conf.backup.* /etc/resolv.conf"
echo ""

# ØªØ³Øª Ù†Ù‡Ø§ÛŒÛŒ
print_status "Ø§Ù†Ø¬Ø§Ù… ØªØ³Øª Ù†Ù‡Ø§ÛŒÛŒ..." "info"
if curl -s -I https://www.youtube.com | grep -q "200 OK"; then
    print_status "âœ¨ Ù‡Ù…Ù‡ Ú†ÛŒØ² Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª! YouTube Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ø§Ø³Øª" "success"
    exit 0
else
    print_status "âš ï¸ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø¶Ø§ÙÛŒ Ø¨Ø§Ø´Ø¯" "warning"
    echo "ðŸ’¡ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ú©Ø§Ù…Ù„ Ø±Ø§ Ø¯Ø± README_LINUX_SERVER.md Ù…Ø·Ø§Ù„Ø¹Ù‡ Ú©Ù†ÛŒØ¯"
    exit 1
fi