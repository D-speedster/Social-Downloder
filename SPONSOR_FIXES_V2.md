# ğŸ”§ Ø±ÙØ¹ Ù…Ø´Ú©Ù„Ø§Øª Ø³ÛŒØ³ØªÙ… Ø§Ø³Ù¾Ø§Ù†Ø³Ø± - Ù†Ø³Ø®Ù‡ 2

## ğŸ› Ù…Ø´Ú©Ù„Ø§Øª Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯Ù‡

### 1. Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ ØºÛŒØ±Ø¶Ø±ÙˆØ±ÛŒ
**Ù…Ø´Ú©Ù„:** Ø¯Ú©Ù…Ù‡ "ğŸ“Š Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ" Ù†ÛŒØ§Ø²ÛŒ Ù†Ø¨ÙˆØ¯ Ú†ÙˆÙ† Ù‡Ø¯Ù Ø±Ø¯ÛŒØ§Ø¨ÛŒ Ù‡Ø± Ù‚ÙÙ„ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ø§Ø³Øª.

**Ø±Ø§Ù‡â€ŒØ­Ù„:**
- âœ… Ø­Ø°Ù Ø¯Ú©Ù…Ù‡ "Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ" Ø§Ø² Ù…Ù†Ùˆ
- âœ… callback Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ Ø¨Ù‡ Ù„ÛŒØ³Øª Ù‚ÙÙ„â€ŒÙ‡Ø§ redirect Ù…ÛŒâ€ŒØ´ÙˆØ¯
- âœ… ÙÙ‚Ø· Ø¢Ù…Ø§Ø± Ù‡Ø± Ù‚ÙÙ„ Ø¨Ù‡ ØµÙˆØ±Øª Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯

### 2. ØªØ¯Ø§Ø®Ù„ Handler
**Ù…Ø´Ú©Ù„:** ÙˆÙ‚ØªÛŒ Ø§Ø¯Ù…ÛŒÙ† `@okalef` Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø§ÙØ²ÙˆØ¯Ù† Ù‚ÙÙ„ Ù…ÛŒâ€ŒÙØ±Ø³ØªØ¯ØŒ handler Ø¯ÛŒÚ¯Ø±ÛŒ Ù¾ÛŒØ§Ù… Ø±Ø§ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯ Ùˆ Ù¾ÛŒØ§Ù… "Ù„ÛŒÙ†Ú© Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø´Ø¯Ù‡ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯" Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.

**Ø±Ø§Ù‡â€ŒØ­Ù„:**
- âœ… Ø³Ø§Ø®Øª custom filter `sponsor_add_active`
- âœ… ØªØºÛŒÛŒØ± group handler Ø§Ø² 5 Ø¨Ù‡ 3 (Ø§ÙˆÙ„ÙˆÛŒØª Ø¨Ø§Ù„Ø§ØªØ±)
- âœ… ÙÙ‚Ø· ÙˆÙ‚ØªÛŒ state Ø§Ø¯Ù…ÛŒÙ† Ø¯Ø± Ø­Ø§Ù„Øª Ø§ÙØ²ÙˆØ¯Ù† Ù‚ÙÙ„ Ø§Ø³ØªØŒ handler ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯

## ğŸ“ ØªØºÛŒÛŒØ±Ø§Øª Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯Ù‡

### `plugins/sponsor_admin.py`

#### 1. Ø­Ø°Ù Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ Ø§Ø² Ù…Ù†Ùˆ
```python
def build_sponsor_admin_menu() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup([
        [InlineKeyboardButton(f"ğŸ“‹ Ù„ÛŒØ³Øª Ù‚ÙÙ„â€ŒÙ‡Ø§ ({locks_count})", callback_data="sponsor_list")],
        [InlineKeyboardButton("â• Ø§ÙØ²ÙˆØ¯Ù† Ù‚ÙÙ„ Ø¬Ø¯ÛŒØ¯", callback_data="sponsor_add")],
        [InlineKeyboardButton("ğŸ—‘ Ø­Ø°Ù Ù‚ÙÙ„", callback_data="sponsor_remove")],
        [InlineKeyboardButton("ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ", callback_data="sponsor_refresh")],
        [InlineKeyboardButton("â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data="back_to_admin")]
    ])
    # âŒ Ø­Ø°Ù Ø´Ø¯: [InlineKeyboardButton("ğŸ“Š Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ", callback_data="sponsor_stats")]
```

#### 2. Ø³Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ callback Ø¢Ù…Ø§Ø±
```python
@Client.on_callback_query(filters.user(ADMIN) & filters.regex(r'^sponsor_stats$'))
async def sponsor_stats_callback(client: Client, callback_query: CallbackQuery):
    """Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª Ù‚ÙÙ„â€ŒÙ‡Ø§ Ø¨Ø§ Ø¢Ù…Ø§Ø± - Ø­Ø°Ù Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ"""
    # ÙÙ‚Ø· Ø¨Ù‡ Ù„ÛŒØ³Øª Ù‚ÙÙ„â€ŒÙ‡Ø§ Ù‡Ø¯Ø§ÛŒØª Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    await sponsor_list_callback(client, callback_query)
```

#### 3. Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Custom Filter
```python
# Custom filter Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ state Ø§Ø¯Ù…ÛŒÙ†
def sponsor_add_filter(_, __, message):
    """ÙÛŒÙ„ØªØ± Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø§Ø¯Ù…ÛŒÙ† Ø¯Ø± Ø­Ø§Ù„ Ø§ÙØ²ÙˆØ¯Ù† Ù‚ÙÙ„ Ø§Ø³Øª"""
    if not message.from_user:
        return False
    user_id = message.from_user.id
    state = get_admin_state(user_id)
    return state.get('action') == 'add' and state.get('step') == 1

sponsor_add_active = filters.create(sponsor_add_filter)
```

#### 4. Ø¢Ù¾Ø¯ÛŒØª Handler Ø¨Ø§ Filter Ùˆ Priority
```python
# Ù‚Ø¨Ù„:
@Client.on_message(filters.user(ADMIN) & filters.private & filters.text, group=5)

# Ø¨Ø¹Ø¯:
@Client.on_message(filters.user(ADMIN) & filters.private & filters.text & sponsor_add_active, group=3)
```

## âœ… Ù†ØªØ§ÛŒØ¬

### Ù‚Ø¨Ù„ Ø§Ø² Ø±ÙØ¹:
```
Ø§Ø¯Ù…ÛŒÙ†: @okalef
Ø±Ø¨Ø§Øª: ğŸ”— Ù„ÛŒÙ†Ú© Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø´Ø¯Ù‡ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯... âŒ
```

### Ø¨Ø¹Ø¯ Ø§Ø² Ø±ÙØ¹:
```
Ø§Ø¯Ù…ÛŒÙ†: @okalef
Ø±Ø¨Ø§Øª: âœ… Ù‚ÙÙ„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯! âœ…
```

## ğŸ§ª ØªØ³Øª

### ØªØ³Øª 1: Ø§ÙØ²ÙˆØ¯Ù† Ù‚ÙÙ„
```
1. Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ† â†’ ğŸ“¢ ØªÙ†Ø¸ÛŒÙ… Ø§Ø³Ù¾Ø§Ù†Ø³Ø±
2. â• Ø§ÙØ²ÙˆØ¯Ù† Ù‚ÙÙ„ Ø¬Ø¯ÛŒØ¯
3. Ø§Ø±Ø³Ø§Ù„ @okalef
4. Ø§Ù†ØªØ¸Ø§Ø±: âœ… Ù‚ÙÙ„ Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆØ¯ (Ù†Ù‡ Ù¾ÛŒØ§Ù… Ø®Ø·Ø§)
```

### ØªØ³Øª 2: Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ
```
1. Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ† â†’ ğŸ“¢ ØªÙ†Ø¸ÛŒÙ… Ø§Ø³Ù¾Ø§Ù†Ø³Ø±
2. Ø¨Ø±Ø±Ø³ÛŒ: Ø¯Ú©Ù…Ù‡ "Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ" Ù†Ø¨Ø§ÛŒØ¯ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
3. ÙÙ‚Ø·: Ù„ÛŒØ³ØªØŒ Ø§ÙØ²ÙˆØ¯Ù†ØŒ Ø­Ø°ÙØŒ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒØŒ Ø¨Ø§Ø²Ú¯Ø´Øª
```

### ØªØ³Øª 3: Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¢Ù…Ø§Ø±
```
1. ğŸ“‹ Ù„ÛŒØ³Øª Ù‚ÙÙ„â€ŒÙ‡Ø§
2. Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ ÛŒÚ© Ù‚ÙÙ„
3. Ø§Ù†ØªØ¸Ø§Ø±: Ø¢Ù…Ø§Ø± Ú©Ø§Ù…Ù„ Ø¢Ù† Ù‚ÙÙ„ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯
```

## ğŸ“Š Ø³Ø§Ø®ØªØ§Ø± Ù†Ù‡Ø§ÛŒÛŒ Ù…Ù†Ùˆ

```
ğŸ” Ù…Ø¯ÛŒØ±ÛŒØª Ù‚ÙÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ø³Ù¾Ø§Ù†Ø³Ø±ÛŒ

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“‹ Ù„ÛŒØ³Øª Ù‚ÙÙ„â€ŒÙ‡Ø§ (2)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â• Ø§ÙØ²ÙˆØ¯Ù† Ù‚ÙÙ„ Ø¬Ø¯ÛŒØ¯     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ—‘ Ø­Ø°Ù Ù‚ÙÙ„             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” Ø¬Ø²Ø¦ÛŒØ§Øª ÙÙ†ÛŒ

### Ø§ÙˆÙ„ÙˆÛŒØª Handler
```python
group=3  # Ø§ÙˆÙ„ÙˆÛŒØª Ø¨Ø§Ù„Ø§ Ø¨Ø±Ø§ÛŒ sponsor_add
group=10 # Ø§ÙˆÙ„ÙˆÛŒØª Ù¾Ø§ÛŒÛŒÙ† Ø¨Ø±Ø§ÛŒ universal handler
```

Ù‡Ø±Ú†Ù‡ Ø¹Ø¯Ø¯ Ú©ÙˆÚ†Ú©ØªØ±ØŒ Ø§ÙˆÙ„ÙˆÛŒØª Ø¨Ø§Ù„Ø§ØªØ±.

### State Management
```python
admin_sponsor_state = {
    user_id: {
        'action': 'add',  # ÛŒØ§ None
        'step': 1,        # Ù…Ø±Ø­Ù„Ù‡ ÙØ¹Ù„ÛŒ
        'data': {}        # Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙ‚Øª
    }
}
```

### Filter Logic
```python
if state.get('action') == 'add' and state.get('step') == 1:
    # ÙÙ‚Ø· Ø¯Ø± Ø§ÛŒÙ† Ø­Ø§Ù„Øª handler ÙØ¹Ø§Ù„ Ø§Ø³Øª
    return True
return False
```

## âš ï¸ Ù†Ú©Ø§Øª Ù…Ù‡Ù…

1. **State Ø¨Ø§ÛŒØ¯ Reset Ø´ÙˆØ¯:**
   - Ø¨Ø¹Ø¯ Ø§Ø² Ù…ÙˆÙÙ‚ÛŒØª: `reset_admin_state(user_id)`
   - Ø¨Ø¹Ø¯ Ø§Ø² Ù„ØºÙˆ: `reset_admin_state(user_id)`
   - Ø¨Ø¹Ø¯ Ø§Ø² Ø®Ø·Ø§: `reset_admin_state(user_id)`

2. **Group Priority:**
   - Sponsor handlers: group=3
   - Universal handlers: group=10
   - Ù‡Ø±Ú¯Ø² Ø§Ø² group=0 Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ú©Ù†ÛŒØ¯ (Ø±Ø²Ø±Ùˆ Ø´Ø¯Ù‡)

3. **Filter Order:**
   - Ø§Ø¨ØªØ¯Ø§ `filters.user(ADMIN)`
   - Ø³Ù¾Ø³ `filters.private`
   - Ø³Ù¾Ø³ `filters.text`
   - Ø¯Ø± Ø¢Ø®Ø± `sponsor_add_active`

## ğŸ¯ Ø®Ù„Ø§ØµÙ‡

âœ… **Ù…Ø´Ú©Ù„ 1 Ø­Ù„ Ø´Ø¯:** Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ Ø­Ø°Ù Ø´Ø¯ØŒ ÙÙ‚Ø· Ø¢Ù…Ø§Ø± Ù‡Ø± Ù‚ÙÙ„ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯

âœ… **Ù…Ø´Ú©Ù„ 2 Ø­Ù„ Ø´Ø¯:** ØªØ¯Ø§Ø®Ù„ handler Ø¨Ø§ custom filter Ùˆ priority Ø¨Ø§Ù„Ø§ØªØ± Ø­Ù„ Ø´Ø¯

âœ… **ØªØ³Øª Ø´Ø¯:** ØªÙ…Ø§Ù… Ø³Ù†Ø§Ø±ÛŒÙˆÙ‡Ø§ ØªØ³Øª Ùˆ ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù†Ø¯

---

**ØªØ§Ø±ÛŒØ®:** 1404/08/09 - 16:00  
**Ù†Ø³Ø®Ù‡:** 2.0  
**ÙˆØ¶Ø¹ÛŒØª:** âœ… ØªÚ©Ù…ÛŒÙ„ Ùˆ ØªØ³Øª Ø´Ø¯Ù‡
