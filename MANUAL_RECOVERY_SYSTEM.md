# 📨 سیستم بازیابی دستی پیام‌ها - مستندات کامل

**تاریخ:** 2025-10-31  
**نسخه:** 2.0.0  
**وضعیت:** ✅ **آماده برای Production**

---

## 🎯 تغییر رویکرد

### قبل (نسخه 1.0):
```
❌ خودکار در startup
❌ ممکن بود اشتباهی پیام بده
❌ کنترل کمتر
❌ 24 ساعت ثابت
```

### بعد (نسخه 2.0):
```
✅ دستی توسط ادمین
✅ کنترل کامل
✅ بازه زمانی انعطاف‌پذیر (1-1440 دقیقه)
✅ گزارش دقیق
```

---

## 🚀 نحوه کار

### فلوچارت:

```
1. ربات آفلاین می‌شود (مثلاً 30 دقیقه)
   ↓
2. کاربران پیام می‌فرستند (50 نفر)
   ↓
3. ربات روشن می‌شود
   ↓
4. ادمین به پنل می‌رود
   ↓
5. کلیک: "📨 پیام‌های آفلاین"
   ↓
6. ربات می‌پرسد: "چند دقیقه قبل؟"
   ↓
7. ادمین می‌نویسد: "45"
   ↓
8. ربات 45 دقیقه اخیر را چک می‌کند
   ↓
9. به تمام 50 نفر پیام می‌دهد
   ↓
10. گزارش کامل به ادمین
```

---

## 📱 نحوه استفاده

### مرحله 1: ورود به پنل ادمین

```
/panel
یا
🛠 مدیریت
```

### مرحله 2: انتخاب گزینه

```
کلیک روی: 📨 پیام‌های آفلاین
```

### مرحله 3: وارد کردن دقیقه

```
ربات می‌پرسد: "چند دقیقه قبل؟"

شما می‌نویسید:
• 10 → برای 10 دقیقه اخیر
• 30 → برای 30 دقیقه اخیر
• 60 → برای 1 ساعت اخیر
• 1440 → برای 24 ساعت اخیر
```

### مرحله 4: صبر کنید

```
ربات شروع می‌کند:
🔄 شروع بازیابی
⏱ بازه زمانی: 30 دقیقه اخیر
⏳ لطفاً صبر کنید...

⏳ در حال پردازش... 10/50
⏳ در حال پردازش... 20/50
...
```

### مرحله 5: دریافت گزارش

```
✅ بازیابی تکمیل شد

📊 آمار:
⏱ بازه زمانی: 30 دقیقه
📨 کل updates: 120
🎯 در بازه زمانی: 50
✉️ پیام‌های ارسال شده: 48
⏰ زمان: 15:30:45
```

---

## 🎓 سناریوهای واقعی

### سناریو 1: کرش کوتاه (10 دقیقه)

```
وضعیت:
- ربات کرش کرد
- 10 دقیقه آفلاین بود
- 15 کاربر پیام فرستادند

اقدام ادمین:
1. ربات را روشن کرد
2. رفت پنل ادمین
3. کلیک: "📨 پیام‌های آفلاین"
4. نوشت: "15"
5. صبر کرد

نتیجه:
✅ 15 کاربر پیام گرفتند
✅ همه راضی شدند
✅ هیچ کاربری از دست نرفت
```

### سناریو 2: Restart برای آپدیت (5 دقیقه)

```
وضعیت:
- نیاز به restart برای آپدیت
- 5 دقیقه آفلاین
- 8 کاربر پیام فرستادند

اقدام ادمین:
1. بعد از restart
2. کلیک: "📨 پیام‌های آفلاین"
3. نوشت: "10"
4. صبر کرد

نتیجه:
✅ 8 کاربر پیام گرفتند
✅ سریع و کارآمد
```

### سناریو 3: مشکل سرور (2 ساعت)

```
وضعیت:
- سرور مشکل داشت
- 2 ساعت آفلاین
- 200 کاربر پیام فرستادند

اقدام ادمین:
1. بعد از رفع مشکل
2. کلیک: "📨 پیام‌های آفلاین"
3. نوشت: "120" (2 ساعت)
4. صبر کرد (ممکن است 5-10 دقیقه طول بکشد)

نتیجه:
✅ 200 کاربر پیام گرفتند
✅ همه بازیابی شدند
✅ تجربه کاربری عالی
```

---

## ⚙️ تنظیمات و محدودیت‌ها

### محدودیت‌های Telegram:

1. **حداکثر 100 update در هر درخواست**
   - سیستم خودکار همه را می‌گیرد

2. **پیام‌ها تا 24 ساعت نگه داشته می‌شوند**
   - بعد از 24 ساعت، Telegram پاک می‌کند

3. **Callback های قدیمی پاسخ داده نمی‌شوند**
   - بعد از چند دقیقه، Telegram expire می‌کند

### محدودیت‌های سیستم:

```python
# حداقل: 1 دقیقه
# حداکثر: 1440 دقیقه (24 ساعت)

if minutes < 1 or minutes > 1440:
    return "عدد نامعتبر"
```

### سرعت پردازش:

```
تقریباً 5 پیام در ثانیه
= 300 پیام در دقیقه
= 18,000 پیام در ساعت

مثال:
- 50 پیام → 10 ثانیه
- 100 پیام → 20 ثانیه
- 500 پیام → 100 ثانیه (1.5 دقیقه)
```

---

## 🔍 عیب‌یابی

### مشکل: "یک فرآیند بازیابی در حال اجرا است"

**علت:** یک بازیابی قبلی هنوز تمام نشده

**راه‌حل:**
```
1. صبر کنید تا تمام شود
2. یا ربات را restart کنید
```

### مشکل: "هیچ پیامی یافت نشد"

**احتمالات:**
1. واقعاً پیامی نبوده
2. بازه زمانی کوتاه بوده
3. پیام‌ها قبلاً پردازش شده‌اند

**راه‌حل:**
```
بازه زمانی بیشتری امتحان کنید
مثلاً به جای 10، بنویسید 30
```

### مشکل: "خطا در بازیابی"

**بررسی:**
```bash
# 1. چک کنید logs
tail -f logs/bot.log | grep manual_recovery

# 2. چک کنید اتصال اینترنت

# 3. چک کنید BOT_TOKEN
```

---

## 📊 آمار و Monitoring

### دستورات مفید:

```bash
# 1. بررسی آمار کلی
/recovery

# 2. بررسی logs
tail -100 logs/bot.log | grep manual_recovery

# 3. بررسی database
sqlite3 bot.db "SELECT * FROM bot_state;"
```

### لاگ‌های مهم:

```bash
# شروع بازیابی
INFO - manual_recovery - 🔄 Starting manual recovery for last 30 minutes

# پیدا کردن updates
INFO - manual_recovery - Found 50 updates in timeframe

# اطلاع‌رسانی
INFO - manual_recovery - Notified user 123456 about missed message

# تکمیل
INFO - manual_recovery - ✅ Manual recovery completed: 48/50 notified
```

---

## 🎯 مقایسه با نسخه قبل

| ویژگی | نسخه 1.0 (خودکار) | نسخه 2.0 (دستی) |
|-------|-------------------|------------------|
| زمان اجرا | Startup | دستی توسط ادمین |
| کنترل | ❌ خیر | ✅ کامل |
| بازه زمانی | 24 ساعت ثابت | 1-1440 دقیقه |
| گزارش | محدود | کامل و دقیق |
| ریسک spam | ⚠️ بالا | ✅ صفر |
| انعطاف | ❌ کم | ✅ زیاد |

---

## ✅ مزایای نسخه جدید

1. **کنترل کامل**
   - ادمین تصمیم می‌گیرد چه موقع
   - ادمین تصمیم می‌گیرد چند دقیقه

2. **بدون spam**
   - فقط وقتی واقعاً نیاز است
   - فقط بازه زمانی مشخص

3. **گزارش دقیق**
   - تعداد کل updates
   - تعداد در بازه زمانی
   - تعداد پیام‌های ارسال شده

4. **انعطاف‌پذیر**
   - از 1 دقیقه تا 24 ساعت
   - قابل تنظیم برای هر موقعیت

5. **ایمن**
   - هیچ پیام اشتباهی نمی‌رود
   - ادمین کنترل دارد

---

## 📝 Checklist استفاده

قبل از استفاده:

- [x] ربات روشن است
- [x] شما ادمین هستید
- [x] می‌دانید چند دقیقه آفلاین بودید

در حین استفاده:

- [x] وارد پنل ادمین شدید
- [x] کلیک کردید: "📨 پیام‌های آفلاین"
- [x] عدد معتبر وارد کردید (1-1440)
- [x] صبر کردید تا تمام شود

بعد از استفاده:

- [x] گزارش را بررسی کردید
- [x] مطمئن شدید همه پیام گرفتند
- [x] آمار را چک کردید

---

## 🎉 نتیجه

**سیستم بازیابی دستی یک راه‌حل حرفه‌ای و کاربردی است!**

### مزایا:
- ✅ کنترل کامل توسط ادمین
- ✅ بدون spam و پیام اشتباهی
- ✅ انعطاف‌پذیر (1-1440 دقیقه)
- ✅ گزارش دقیق و کامل
- ✅ سریع و کارآمد
- ✅ آماده برای production

### کاربردها:
- ✅ بعد از کرش ربات
- ✅ بعد از restart برای آپدیت
- ✅ بعد از مشکل سرور
- ✅ هر زمان که ربات آفلاین بوده

---

## 📞 دستورات سریع

```bash
# ورود به پنل
/panel

# بازیابی 10 دقیقه اخیر
📨 پیام‌های آفلاین → 10

# بازیابی 30 دقیقه اخیر
📨 پیام‌های آفلاین → 30

# بازیابی 1 ساعت اخیر
📨 پیام‌های آفلاین → 60

# بازیابی 24 ساعت اخیر
📨 پیام‌های آفلاین → 1440
```

---

**تاریخ تکمیل:** 2025-10-31  
**نسخه:** 2.0.0-production-ready  
**وضعیت:** ✅ **READY FOR PRODUCTION**

🚀 **حالا یک سیستم حرفه‌ای و کاربردی دارید!**
